---
title: "はじめに"
---

インタプリタとかコンパイラとかいわゆる言語処理系って中はどうなってるの？なんか面白そうだけど難しいんじゃ？と思っている方[^myself]に、入り口は意外とそうでもないんだよと伝えたくて書いてみました。

[^myself]: 以前の私です。

以下のようなことを狙って書いています。

* 言語処理系の勉強をしたことがないひとでもちょっと読んでみようかなと思えること
* 言語処理系の基礎がわかり、自分でもできそうだなと感じられること
* ちょっといじってみよう、自分で書いてみようと思えること
* 本格的な本を読んでみようと思った時の準備になること

特に、自分で書いてみるというのはおすすめです。読むだけのときと比べると時間はかかりますがやはり理解度が段違いです。
350行くらいなら自分でも書けるかも？という気になってもらうことを狙っています[^300lines]。
また、これくらいのサイズだと全体を一度に頭に入れることも可能で、学習の初期には適していると考えています。
コードのサイズ感については"付録：全ソースコード" または https://github.com/koba925/minilang-book/blob/main/minilang.py を見てみてください。

[^300lines]: 300行に収められたらいいなと思っていたのですが、入れたいものを入れてたら超えてしまいました。
姑息な真似までして300行に収めたソースは https://github.com/koba925/minilang-book/blob/300lines/minilang.py です。

## 作るもの

こんなコードが動かせるようになります。
Pythonで書きますが、作る言語はJavaScriptっぽいものです。
盛りだくさんというわけにはいきませんが、意外と書ける感じがしませんか？

GCDを求める（制御構造）

```
def gcd(a, b) {
    var tmp = 0;
    while b # 0 {
        if less(a, b) {
            set tmp = a; set a = b; set b = tmp;
        }
        set a = a - b;
    }
    return a;
}
print gcd(36, 12);
```

フィボナッチ数列（再帰）

```
def fib(n) {
    if n = 1 { return 1; }
    if n = 2 { return 1; }
    return fib(n - 1) + fib(n - 2);
}
print fib(6);
```

カウンター（クロージャ）

```
def counter() {
    var count = 0;
    return func() {
        set count = count + 1;
        return count;
    };
}
var c = counter();
print(c());
print(c());
print(c());
```

## 勉強すること

コンパクトにする一方で、インタプリタ実装上の基本的なコンセプトはできるだけ入るように考えました。
以下のコンセプトをカバーしています。

* 字句解析・構文解析（再帰下降解析）・評価
* 文・式
* 優先順位・結合順
* 変数・環境・スコープ
* 型（動的型）
* 制御構造
* 関数・クロージャ
* 糖衣構文

省いたものは配列・辞書などのデータ構造やクラス、エラー処理、高速化あたりです。
そのあたりは次のステップに進んでから勉強していただくということで。

## こだわりとおことわり

この本のソースコードはPythonの標準的なスタイルに比べると改行が少なく、1行に詰め込んだ形になっています。
細かく改行して画面左側にソースが偏り、その分行数が増えてしまうよりも、縦横バランスよく伸びていたほうがひと目で見渡せる範囲が広く、理解が進みやすいと考えているためです[^formatter]。
また、コメントは入っていませんが、本があるということでご了承ください。関数名・変数名はすこし長めにしてわかりやすくしたつもりです。
それ以外はまあまあ普通に書いたつもりです。
制御構造やクラスは知っている、くらいの読者も想定して、基本を超えてるなと思ったところは都度説明しています。

[^formatter]: そのため、フォーマッタをかけると400行くらいになります。
あっ、石を投げないで！

言語処理系の動作を理解するのが主な目的なので、便利なツールやライブラリは使わず、イチから自分で書きます。
「イチ」といってもいろいろありますが、この本ではPythonの基礎的な機能のみを使っています。
インポートするライブラリは`sys`だけで、使っているのも`sys.stdin.read()`だけです。
また、本格的な言語処理系の勉強・開発にもつながるよう、大きなアーキテクチャは基本通りに作っています（単純化したところはいたるところにあります）。

本の方もあまり長くならないように、また、読み進めやすいように考えました。
最初はこれでプログラミング言語？と思うような本当に最小限の機能だけのインタプリタを作り、少しずつコードを追加していきます。
本というよりもブログ連載くらいのつもりでさらっと読んでいただければと思います。

コードはすべて本文に載せるようにしていますので、ダウンロードしてエディタで開くとかGitHubを参照するとかしなくても読めます。
エディタやGitHubが使える環境では使った方が便利なので都度GitHubのリンクは置いていきます。

## 環境

WSL + Python 3.12で動作確認しています。
match文を大々的に使っているので、Python 3.10以上が必要だと思います。

ソースコードすべて本文中にありますが、 https://github.com/koba925/minilang-book でも参照することができます。
サンプルごとにcommitしているので、差分も見ることができます。

vscodeでdevcontainerを作って動かす環境になっていますので、vscode+dockerの環境があれば簡単に動かせるはずです。
（自分の環境以外では試していないのでうまくいかなかったらすみません）
将来堂々とリポジトリごと作り直したりするかもしれない[^remake]ので、cloneとかforkとかした後はご注意ください。
zipでダウンロードして展開するのが一番安全かもしれません。

[^remake]: 「ああ、ここはこう書いておけばよかった」というとき、修正したところから全部に反映していく必要があって、うまい方法が思いついていないので。なにかいい方法ご存じでしたら教えてください。

## 余談：簡単なとは？

（どこに書くとよい？
簡単な仕様とは
次を読むだけで（先読みしないで）
今読んでいるひとかたまりが終わりかどうかわかる
次が何なのかわかる

Fortranが作られたころは言語処理系の理論もなく、今の言語だったら避けるような文法があります。
当時は高級言語もなくアセンブリ言語で書くしかない状態だったのによく書けたものだなと思います。

