---
title: "はじめに"
---

本書は350行弱のPythonのプログラムで、小さな、でも基本的な要素をそなえたインタプリタを書きながら言語処理系の基本を勉強しようという本です[^300lines]。超絶技巧で短くするということではなくて、350行程度で書ける仕様に絞って普通に書く、ということです。実用性は二の次になっています。ただでさえ速くはないPythonでインタプリタを書くわけで実行速度にはもとから期待できませんし。機能は絞りますが、特殊な仕様にはせず、見た目はだいたい普通のプログラミング言語にします。

[^300lines]: 300行に収められたらいいなと思っていたのですが、入れたいものを入れてたら超えてしまいました。姑息な真似までして300行に収めたソースもあります（https://github.com/koba925/minilang-book/blob/300lines/minilang.py）。

インタプリタとかコンパイラとかいわゆる言語処理系って中はどうなってるの？なんか面白そうだけど難しいんじゃ？と思っている方[^myself]が勉強を始めるとっかかりにしてもらえれば、と思います。読み終わったとき、こうなってもらえればと思って書きました。

[^myself]: 以前の私です。

* 言語処理系の勉強をしたことがないひとでもちょっと読んでみようかなと思えること
* ちょっといじってみよう、自分で書いてみようと思えること
* 言語処理系（インタプリタ）の基礎がわかり、本格的な本を読む準備になること

コードが短いので全体を一度に頭に入れることが可能で、改造もしやすく、学習の初期には適しているはずです。コードのサイズ感については "付録：全ソースコード" または https://github.com/koba925/minilang-book/blob/main/minilang.py を見てみてください。

言語処理系の中身がわかると、既存のプログラミング言語を覚えたり使ったりするときもほんのりと「ここはこういうことだったんだな」とわかったりして楽しかったり役に立ったりします。日ごろフレームワークとかライブラリとかを忙しく調べてる方がちょっと目先を変えて勉強してみるのもよいのではないかなと思います。

# 作るもの

こんなコードが動かせるようになります。処理系はPythonで書きますが、作る言語の雰囲気はJavaScriptに近いです。自分の好みもありますが、言語処理系の本で作る言語はC言語寄りであることが多いのでつながりも考えて。すこし見慣れないところもあると思いますが、今は気になさらず。

GCD（制御構造の例）

```
def gcd(a, b) {
    var tmp = 0;
    while b # 0 {
        if less(a, b) {
            set tmp = a; set a = b; set b = tmp;
        }
        set a = a - b;
    }
    return a;
}
print gcd(36, 12);
```

フィボナッチ数列（再帰の例）

```
def fib(n) {
    if n = 1 { return 1; }
    if n = 2 { return 1; }
    return fib(n - 1) + fib(n - 2);
}
print fib(6);
```

カウンター（無名関数・クロージャの例）

```
def counter() {
    var count = 0;
    return func() {
        set count = count + 1;
        return count;
    };
}
var c = counter();
print(c());
print(c());
print(c());
```

盛りだくさんというわけにはいきませんが、意外と普通の言語に見えませんか？

# 勉強すること

コンパクトにする一方で、インタプリタ実装上の基本的なコンセプトはできるだけ入るように考えました。以下のコンセプトをカバーしています。

* ツリーウォーク型インタプリタ
* 字句解析・構文解析（再帰下降解析）・評価
* 文・式
* 優先順位・結合順
* 変数・環境・スコープ
* 動的型付け
* 制御構造
* 関数・無名関数・クロージャ
* 構文糖衣

逆に、これら以外のものはできるだけ排除しました。たとえばソースコードをファイルから読み込むことすらしていません。ソースコードを文字列として引数にとるメソッドがあるだけです（代わりに簡単なREPLを実装しています）。

ツリーウォーク型インタプリタというのは、後述する抽象構文木をたどりながら実行していくタイプのインタプリタで、最も基本的な構成と言えます。インタプリタの作り方はさまざまありますが、本書ではツリーウォーク型インタプリタにしぼって説明していきます。

文字列、配列・辞書などのデータ構造やクラス、エラー処理、最適化・高速化などには触れていません。そのあたりは次のステップに進んでから勉強していただくということで。

# こだわりとおことわり

今後本格的な言語処理系の勉強・開発にもつながるよう、大まかには普通のインタプリタの構成を踏襲しました（単純化したところはいたるところにあります）。また、用語の紹介を多めにしています。

言語処理系の動作を理解するのが主な目的なので、便利なツールやライブラリは使わず、イチから自分で書きます。「イチ」といってもいろいろありますが、本書ではPythonの基礎的な機能のみを使っています。インポートするライブラリは`sys`だけで、使っているのも`sys.stdin.read()`だけです（一時的に正規表現ライブラリを使いますがすぐに書き換えます）。

ソースコードはそれほど凝った書き方はせず、（自分基準では）普通に書いたつもりです。制御構造やクラスは知っている、くらいの読者も想定して、基本を超えてるなと思ったところは都度説明しています。コメントも入っていませんが、本があるということでご了承ください。関数名・変数名はすこし長めにしてわかりやすくしたつもりです。

ただし、本書のソースコードはPythonの標準的なスタイルに比べると改行が少なく、1行に詰め込んだ形になっています[^formatter]。細かく改行して画面左側にソースが偏り、その分行数が増えてしまうよりも、縦横バランスよく伸びていたほうがひと目で見渡せる範囲が広く、内容が把握しやすいと考えているためです[^style-guide]。

[^formatter]: そのため、フォーマッタをかけると400行くらいになります。あっ、石を投げないでください！

[^style-guide]: チームで書くプログラムはちゃんとスタイルガイドに従いましょう。

文章の方は、できあがったコードをパーツごとに開設するような形ではなく、最初はこれでプログラミング言語？と思うような本当に最小限の機能だけのインタプリタを作り、少しずつコードを追加しては解説して動かすという形にしています。開発を体験してるような気分になっていただこうという狙いです。コンパクトにするよりも読み進めやすいように考えました。とはいっても１冊の本となるようなボリュームではなく、小冊子くらいに収まっているんじゃないかなと思います[^volume]。

[^volume]: Zennで見てみると13万文字くらいあります。思ったより多かった。でもコードを全部載せたり、脚注やら余談やらが多いので本文の日本語はそこまででもないんじゃないかと・・・

コードはすべて本文に載せていますので、ダウンロードしてエディタで開くとかGitHubを参照する必要はありません。とはいうものの、エディタやGitHubが使える環境では使った方が便利ということもあるので都度GitHubへのリンクを置いていきます。

# 開発環境

WSL + Python 3.12で動作確認しています。ピュアPythonなのでPythonが動けばどこでも動くと思いますが、match文を大々的に使っているのでPython 3.10以上が必要だと思います。

ソースコードはすべて本文中にありますが、 https://github.com/koba925/minilang-book でも参照することができます[^remake]。サンプルごとにブランチを切っているので、差分も見ることができます。今呼んでいるソースがどのブランチに対応するかはブランチ名を見ればわかるようになっています。

[^remake]: 将来堂々とリポジトリごと作り直したりする可能性もあるのでご注意ください。「ああ、ここはこう書いておけばよかった」というとき、修正したところから全部に反映していく必要があるので。なにかうまい管理方法をご存じでしたら教えてください。

vscodeでdevcontainerを作って動かす環境になっていますので、vscode+dockerの環境があれば簡単に動かせるはずです。自分の環境以外では試していないのでうまくいかなかったらすみません。

では始めましょう。