---
title: "はじめに"
---

本書は350行弱のPythonのプログラムで、小さな、でも基本的な要素をそなえたプログラミング言語を作りながらプログラミング言語実装の基本を勉強しようという本です[^300lines]。超絶技巧で短くするということではなくて、機能を絞ることで350行程度に収めていますのでコード自体は普通で、Pythonの基本的なところがわかっていれば読むのにそれほど苦労はしないと思います。機能は絞りますが、特殊な文法にはせず、見た目はだいたい普通のプログラミング言語にします。

[^300lines]: 300行に収められたらいいなと思っていたのですが、入れたいものを入れてたら超えてしまいました。姑息な真似までして300行に収めたソースもあります（https://github.com/koba925/minilang-book/blob/300lines/minilang.py）。

プログラミング言語って中はどうなってるの？なんか面白そうだけど難しいんじゃ？と思っている方[^myself]が勉強を始めるとっかかりにしてもらえれば、と思います。

[^myself]: 以前の私です。

* プログラミング言語実装の勉強をしたことがないひとでもちょっと読んでみようかなと思えること
* ちょっといじってみよう、自分で書いてみようと思えること
* プログラミング言語実装の基礎がわかり、本格的な本を読む準備になること

コードが短いので全体を一度に頭に入れることが可能で、改造もしやすく、学習の初期には適しているはずです。コードのサイズ感については "付録：全ソースコード" または https://github.com/koba925/minilang-book/blob/main/minilang.py を見てみてください。

全くこういった勉強をしたことがない人にとっては初めて見る言葉がたくさん出てくると思います。できるだけ説明するようにしますが、コードを実際に見てみたり、全体がわかってからでないと意味がピンとこない部分があるかもしれません。知らない言葉が出てきてもそこであきらめず、先に進んでみてください。短いのでいったん最後までざっと見てからもう一度読んでみるというのもありだと思います。もちろん検索したり本を探してじっくり調べるのもよいことです。

言語処理系の中身がわかると、既存のプログラミング言語を覚えたり使ったりするときもほんのりと「ここはこういうことだったんだな」とわかったりして楽しかったり役に立ったりします。日ごろフレームワークとかライブラリとかを忙しく調べてる方がちょっと目先を変えて勉強してみるのもよいのではないかなと思います。

# 作るもの

こんなコードが動かせるようになります。処理系はPythonで書きますが、作る言語の雰囲気はJavaScriptに近いです。自分の好みもありますが、言語処理系の本で作る言語はC言語寄り[^or-pascal]であることが多いのでつながりも考えてそうしています。すこし見慣れないところもあると思いますが、今は気になさらず。

[^or-pascal]: またはPascal系・・・と言ってもターゲットとしている読者層には通じないかも・・・

最大公約数（GDC）を求めるプログラム。条件分岐（if文）や繰り返し（while文）は当然書けます。

```
def gcd(a, b) {
    var tmp = 0;
    while b # 0 {
        if less(a, b) {
            set tmp = a; set a = b; set b = tmp;
        }
        set a = a - b;
    }
    return a;
}
print gcd(36, 12);
```

フィボナッチ数列を求めるプログラム。再帰（自分自身を呼ぶこと）も問題ありません。

```
def fib(n) {
    if n = 1 { return 1; }
    if n = 2 { return 1; }
    return fib(n - 1) + fib(n - 2);
}
print fib(6);
```

カウンターを作るプログラム。おもしろいものではありませんが無名関数・クロージャ（あとで出てきます）の例として。

```
def counter() {
    var count = 0;
    return func() {
        set count = count + 1;
        return count;
    };
}
var c = counter();
print(c());
print(c());
print(c());
```

盛りだくさんというわけにはいきませんが、意外と普通の言語に見えませんか？

# 勉強すること

本書ではインタプリタの実装を学びます・・・といってもインタプリタって何？というひともいるかもしれませんね。

ソースプログラムを読んで実行したりコンパイルしたりするプログラムのことを言語処理系と言います。言語処理系には大きく分けてインタプリタとコンパイラのふたつがあります。有名どころのインタプリタにはPythonやJavaScriptなどが、コンパイラにはCやGo、Rustなどがあります。インタプリタとコンパイラの違いについて書き始めると章がひとつできてしまいますが、本書では「ソースを読んですぐ実行するのがインタプリタ、いったんファイルを出力してそれを実行するのがコンパイラ」くらいに理解しておいてください[^outline]。

[^outline]: このように、本書ではいろいろ用語を紹介していきますが細かい説明には踏み込まず、コードを読んだり書いたりしてイメージをつかんでいくことを優先します。

インタプリタだといったんファイルに出力するという工程がない分コンパイラよりもイメージがつかみやすいはずです。インタプリタの実装の中にもコンパイラの実装につながる部分はたくさんありますのでいずれはコンパイラと思っている方でもムダはありません。

本書では、実装を小さくする一方で、インタプリタ実装上の基本的なコンセプトはできるだけ入るように考えました。以下のコンセプトをカバーしています。知らない言葉が並んでいるかもしれませんが、本書を読み終わるころにはこれらの用語や実装のイメージができているはずです。

* ツリーウォーク型インタプリタ
* 字句解析・構文解析（再帰下降解析）・評価
* 文・式
* 優先順位・結合順
* 変数・環境・スコープ
* 動的型付け
* 制御構造
* 関数・無名関数・クロージャ
* 構文糖衣

逆に、これら以外のものはできるだけ排除しました。たとえばソースコードをファイルから読み込むことすらしていません。ソースコードを文字列として引数にとるメソッドがあるだけです（代わりに簡単なREPLを実装しています）。

ツリーウォーク型インタプリタというのは、後述する抽象構文木をたどりながら実行していくタイプのインタプリタで、最も基本的な構成と言えます（今は何を言ってるかわからなくて大丈夫です）。インタプリタの作り方はさまざまありますが、本書ではツリーウォーク型インタプリタにしぼって説明していきます。

文字列、配列・辞書などのデータ構造やクラス、エラー処理、最適化・高速化などには触れていません。そのあたりは次のステップに進んでから勉強していただくということで。

# こだわりとおことわり

今後本格的な言語処理系の勉強・開発にもつながるよう、大まかには普通のインタプリタの構成を踏襲しました（単純化したところはいたるところにあります）。また、用語の紹介を多めにしています。

インタプリタを書くのにインタプリタを使うというのは普通はしない（遅くなるので）選択なのですが、普及している言語の中で、学習向けにコンパクトで読みやすく実装できそうなものということでPythonを採用しました。実用性は二の次です。

言語処理系の動作を理解するのが主な目的なので、便利なツールやライブラリは使わず、イチから自分で書きます。「イチ」といってもいろいろありますが、本書ではPythonの基礎的な機能のみを使っています。インポートするライブラリは`sys`だけで、使っているのも`sys.stdin.read()`だけです（一時的に正規表現ライブラリを使いますがすぐに書き換えます）。

ソースコードはそれほど凝った書き方はせず、（自分基準では）普通に書いたつもりです。制御構造やクラスは知っている、くらいの読者も想定して、基本を超えてるなと思ったところは都度説明しています。match文を多用していて、なじみのない方もいるかと思いますが、都度説明していきますので慣れてくると思います。コメントも入っていませんが、本があるということでご了承ください。関数名・変数名はすこし長めにしてわかりやすくしたつもりです。

ただし、本書のソースコードはPythonの標準的なスタイルに比べると改行が少なく、1行に詰め込んだ形になっています[^formatter]。細かく改行して画面左側にソースが偏り、その分行数が増えてしまうよりも、縦横バランスよく伸びていたほうがひと目で見渡せる範囲が広く、内容が把握しやすいと考えているためです[^style-guide]。

[^formatter]: そのため、フォーマッタをかけると400行くらいになります。あっ、石を投げないでください！

[^style-guide]: チームで書くプログラムはちゃんとスタイルガイドに従いましょう。

文章の方は、できあがったコードをパーツごとに解説するような形ではなく、最初はこれでプログラミング言語？と思うような本当に最小限の機能だけのインタプリタを作り、少しずつコードを追加しては解説して動かすという形にしています。開発を体験してるような気分になっていただこうという狙いです。コンパクトにするよりも読み進めやすいように考えました。とはいっても１冊の本となるようなボリュームではなく、小冊子くらいに収まっているんじゃないかなと思います[^volume]。

[^volume]: Zennで見てみると13万文字くらいあります。思ったより多かった。でもコードを全部載せたり、脚注やら余談やらが多いので本文の日本語はそこまででもないんじゃないかと・・・

コードはすべて本文に載せていますので、ダウンロードしてエディタで開くとかGitHubを参照する必要はありません。とはいうものの、エディタやGitHubが使える環境では使った方が便利ということもあるので都度GitHubへのリンクを置いていきます。

# 開発環境

WSL + Python 3.12で動作確認しています。ピュアPythonなのでPythonが動けばどこでも動くと思いますが、match文を大々的に使っているのでPython 3.10以上が必要だと思います。

ソースコードはすべて本文中にありますが、 https://github.com/koba925/minilang-book でも参照することができます[^remake]。サンプルごとにブランチを切っているので、差分も見ることができます。今呼んでいるソースがどのブランチに対応するかはブランチ名を見ればわかるようになっています。

[^remake]: 将来堂々とリポジトリごと作り直したりする可能性もあるのでご注意ください。「ああ、ここはこう書いておけばよかった」というとき、修正したところから全部に反映していく必要があるので。なにかうまい管理方法をご存じでしたら教えてください。

vscodeでdevcontainerを作って動かす環境になっていますので、vscode+dockerの環境があれば簡単に動かせるはずです。自分の環境以外では試していないのでうまくいかなかったらすみません。

では始めましょう。