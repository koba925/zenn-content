---
title: "はじめに"
---

インタプリタとかコンパイラとかいわゆる言語処理系って中はどうなってるの？なんか面白そうだけど難しいんじゃ？と思っているひと[^myself]の心の壁が少しでも低くなればと思って書いてみました。

[^myself]: 以前の私です。

以下のようなことを狙って書いています。

* 言語処理系の勉強をしたことがないひとでもちょっと読んでみようかなと思えること
* 言語処理系の基礎がわかり、自分でもできそうだなと感じられること
* ちょっといじってみよう、自分で書いてみようと思えること
* 本格的な本を読んでみようと思った時の準備になること

特に、自分で書いてみるというのはおすすめです。
読むだけのときと比べると時間はかかりますがやはり理解度が段違いです。
350行くらいなら自分でも書けるかも？という気になってもらうことを狙っています[^300lines]。
コードのサイズ感については"付録：全ソースコード" または https://github.com/koba925/minilang-book/blob/main/minilang.py を見てみてください。

[^300lines]: 300行に収められたらいいなと思っていたのですが、入れたいものを入れてたら超えてしまいました。

## 作るもの

こんなコードが動かせるようになります。
Pythonで書きますが、作る言語はJavaScriptっぽいものです。
盛りだくさんというわけにはいきませんが、意外と書ける感じがしませんか？

GCDを求める（制御構造）

```
def gcd(a, b) {
    var tmp = 0;
    while b # 0 {
        if less(a, b) {
            set tmp = a; set a = b; set b = tmp;
        }
        set a = a - b;
    }
    return a;
}
print gcd(36, 12);
```

フィボナッチ数列（再帰）

```
def fib(n) {
    if n = 1 { return 1; }
    if n = 2 { return 1; }
    return fib(n - 1) + fib(n - 2);
}
print fib(6);
```

カウンター（クロージャ）

```
def counter() {
    var count = 0;
    return func() {
        set count = count + 1;
        return count;
    };
}
var c = counter();
print(c());
print(c());
print(c());
```

## 勉強すること

コンパクトにする一方で、インタプリタ実装上の基本的なコンセプトはできるだけ入るように考えました。
以下のコンセプトをカバーしています。

* 字句解析・構文解析（再帰下降解析）・評価
* 文・式
* 優先順位・結合順
* 変数・環境・スコープ
* 型（動的型）
* 制御構造
* 関数・クロージャ
* 糖衣構文

省いたものは配列・辞書などのデータ構造やクラス、エラー処理、高速化あたりです。
そのあたりは次のステップに進んでから勉強していただくということで。

## 環境

WSL + Python 3.12で動作確認しています。
match文を大々的に使っているので、Python 3.10以上が必要だと思います。
GitHubのリポジトリにはvscodeのdevcontainerの設定が入っていますので、環境が整っていればすぐにコンテナで動かせます。

Windows上でも普通に動きますが、REPLの入力方法が多少変わりますので少しだけ注意してください。

## こだわりとおことわり

この本のソースコードはPythonの標準的なスタイルに比べると改行が少なく、1行に詰め込んだ形になっています。
物理的な行数が理解のしやすさに影響するような気がしていて、縦横バランスよく伸びていたほうが見渡せる範囲が広く、理解が進みやすいのではないかと考えているためです[^formatter]。

[^formatter]: そのため、フォーマッタをかけると400行くらいになります。
あっ、石を投げないで！

また、コメントは入っていませんが、本があるということでご了承ください。
関数名・変数名はすこし長めにしてわかりやすくしたつもりです。

コンパクトにする以外では

本格的な言語処理系の勉強・開発にもつながるよう、大きなアーキテクチャは基本通りに作っています（単純化したところはいたるところにあります）。

言語処理系の動作を理解するのが主な目的なので、便利なツールやライブラリは使わず、イチから自分で書きます。
「イチ」といってもいろいろありますが、この本ではPythonの基礎的な機能のみを使っています。
インポートするライブラリは`sys`だけで、使っているのも`sys.stdin.read()`だけです。

Python自体も、難しい書き方はあまりしないようにしています。
制御構造やクラスは知っている、くらいの読者も想定して、基本を超えてるなと思ったところは都度説明しています。

一方、本の方はあまり長くならないようにとも考えていますが、それよりも読み進めやすさを重視しました。
最初はこれでプログラミング言語？と思うような本当に最小限の機能だけのインタプリタを作り、少しずつコードを追加していきます。
本というよりもブログ連載くらいのつもりでさらっと読んでいただければと思います。
（実際始めはそのつもりだった）

コードはすべて載せるようにしていますので、ダウンロードしてエディタで開くとかGitHubを参照するとかしなくても読めます。
エディタやGitHubが使える環境では使った方が便利なこともあるので都度GitHubのリンクは置いていきます。
リポジトリは https://github.com/koba925/minilang-book です。
サンプルごとにcommitしているので、差分も見ることができます。

vscodeでdevcontainerを作って動かす環境になっていますので、vscode+dockerの環境があれば簡単に環境構築ができます。
（自分の環境以外では試していないのでうまくいかなかったらすみません）
将来堂々とリポジトリごと作り直したりするかもしれない[^remake]ので、cloneとかforkとかした後はご注意ください。
zipでダウンロードして展開するのが一番安全かもしれません。

[^remake]: 「ああ、ここはこう書いておけばよかった」というとき、修正したところから全部に反映していく必要があって、うまい方法が思いついていないので。なにかいい方法ご存じでしたら教えてください。

## 余談：簡単なとは？

（どこに書くとよい？
簡単な仕様とは
次を読むだけで（先読みしないで）
今読んでいるひとかたまりが終わりかどうかわかる
次が何なのかわかる

Fortranが作られたころは言語処理系の理論もなく、今の言語だったら避けるような文法があります。
当時は高級言語もなくアセンブリ言語で書くしかない状態だったのによく書けたものだなと思います。

